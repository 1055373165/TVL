# 搭建以太坊私链



# 下载

1. 下载 geth 项目

> git clone [https://github.com/ethereum/go-ethereum.git](https://github.com/ethereum/go-ethereum.git)

1. 编译 geth cli  可执行文件 （位于 build/bin 目录下）

> make geth

1. 将可执行文件添加到环境变量中

> cp /build/bin/geth /usr/local/bin

1. 测试

> geth —help

# 搭建私有链

1. 配置初始状态

要运行以太坊私有链，需要定义自己的创世区块，创世区块信息写在一个 JSON 格式的配置文件中。首先将下面的内容保存到一个 JSON 文件中，例如 `genesis.json`

<aside>
😈 mkdir  workspace/privatechain


cd privatechain

mkdir data0

vi genesis.json

</aside>

```markdown
"config": {
        "chainId": 10, 
        "homesteadBlock": 0,
        "eip150Block": 0,
        "eip155Block": 0
    },
  "alloc"      : {},
  "coinbase"   : "0x0000000000000000000000000000000000000000",
  "difficulty" : "0x20000",
  "extraData"  : "",
  "gasLimit"   : "0x2fefd8",
  "nonce"      : "0x0000000000000042",
  "mixhash"    : "0x0000000000000000000000000000000000000000000000000000000000000000",
  "parentHash" : "0x0000000000000000000000000000000000000000000000000000000000000000",
  "timestamp"  : "0x00"
}
```

其中，chainID 指定了独立的区块链网络 ID。网络 ID 在连接到其他节点的时候会用到，以太坊公网的网络 ID 是 1，为了不与公有链网络冲突，运行私有链节点的时候要指定自己的网络 ID。不同 ID 网络的节点无法相互连接。配置文件还对当前挖矿难度 difficulty、区块 Gas 消耗限制 gasLimit 等参数进行了设置。

1. 初始化： 写入创世区块

准备好创世区块配置文件后，需要`初始化区块链`，将上面的创世区块信息写入到区块链中。首先要新建一个目录用来存放区块链数据，假设新建的数据目录为 ~/privatechain/data0，genesis.json 保存在 ~/privatechain 中，此时目录结构应该是这样的：

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled.png)

执行初始化命令

> geth init  —datadir data0  genesis.json

上面的命令的主体是 `geth init`，表示初始化区块链，命令可以带有选项和参数，其中 `--datadir` 选项后面跟一个目录名，这里为 `data0`，表示指定数据存放目录为 `data0`，`genesis.json` 是 `init` 命令的参数。

运行上面的命令，会读取 `genesis.json` 文件，根据其中的内容，将创世区块写入到区块链中。如果看到以下的输出内容，说明初始化成功了。

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%201.png)

初始化成功后，会在数据目录 data0 中生成 `geth` 和 `keystore` 两个文件夹，此时目录结构如下：

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%202.png)

其中 `geth/chaindata` 中存放的是区块数据，`keystore` 中存放的是账户数据。

1. 启动私有链节点

> geth console —networkid 110 —datadir data0

上面命令的主体是 `geth console`，表示启动节点并进入交互式控制台，-–datadir选项指定使用data0作为数据目录，`--networkid` 选项后面跟一个数字，这里是`110`，表示指定这个私有链的网络id为110。

网络id在连接到其他节点的时候会用到，以太坊公网的网络id是1，为了不与公有链网络冲突，运行私有链节点的时候要指定自己的网络id。

运行上面的命令后，就启动了区块链节点并进入了该节点的控制台：

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%203.png)

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%204.png)

这是一个交互式的 JavaScript 执行环境，在这里面可以执行 JavaScript 代码，其中 > 是命令提示符。在这个环境里也内置了一些用来操作以太坊的 JavaScript 对象，可以直接使用这些对象。这些对象主要包括：

- eth：包含一些跟操作区块链相关的方法；
- net：包含一些查看`p2p网络状态`的方法；
- admin：包含一些与`管理节点`相关的方法；
- miner：包含启动&停止挖矿的一些方法；
- personal：主要包含一些管理账户的方法；
- txpool：包含一些查看交易内存池的方法；
- web3：包含了以上对象，还包含一些单位换算的方法。

# 控制台操作

进入以太坊 Javascript Console 后，就可以使用里面的内置对象做一些操作，这些内置对象提供的功能很丰富，比如查看区块和交易、创建账户、挖矿、发送交易、部署智能合约等。

常用命令有：

- personal.newAccount()：创建账户；
- personal.unlockAccount()：解锁账户；
- eth.accounts：`枚举`系统中的账户；
- eth.getBalance()：查看账户余额，返回值的单位是 `Wei`（Wei 是以太坊中最小货币面额单位，类似比特币中的聪，1 ether = 10^18 Wei）；
- eth.blockNumber：列出区块总数；
- eth.getTransaction()：获取交易；
- eth.getBlock()：获取区块；
- miner.`start()`：开始挖矿；
- miner.stop()：停止挖矿；
- eth.coinbase：挖矿奖励的账户
- web3.fromWei()：Wei 换算成以太币；
- web3.toWei()：以太币换算成 Wei；
- txpool.status：交易池中的状态；
- admin.addPeer()：连接到其他节点；

1. 创建账户

输入 `eth.accounts` 查询系统中的账户：

> eth.accounts

显示为 `[]`，表示没有账户，接下来使用 `personal.newAccount()` 来创建一个账户：

> personal.newAccount()

输入两次密码，得到 `0x593abc88dfd6c6078f3739e7d6a3420d5b3609dd`

再次创建一个账户

`0xfe1aba3e41de132145767943f4e046d004b4a12e`

账户默认会保存在数据目录的 `data0/keystore` 文件夹中。可以查看其中的文件

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%205.png)

1. ****查看账户余额****

> eth.getBalance(”address”)

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%206.png)

目前两个账户的以太币余额都是0，要使账户有余额，可以从其他账户转账过来，或者通过挖矿来获得以太币奖励。

1. ****启动&停止挖矿****

通过 `miner.start()` 启动挖矿

> miner.start()

其中 start 的参数表示挖矿使用的`线程数`。第一次启动挖矿会先生成挖矿所需的 DAG 文件，这个过程有点慢，等进度达到 100% 后，就会开始挖矿，此时屏幕会被挖矿信息刷屏。

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%207.png)

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%208.png)

停止挖矿，在 console 中输入：

> miner.stop()

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%209.png)

挖到一个区块会奖励5个以太币，挖矿所得的奖励会进入矿工的账户，这个账户叫做coinbase，默认情况下coinbase是本地账户中的第一个账户：

> eth.coinbase

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2010.png)

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2011.png)

可以通过 `miner.setEtherbase()` 将其他账户设置成 `coinbase` 即可

> miner.setEtherbase(”`0xfe1aba3e41de132145767943f4e046d004b4a12e`”)

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2012.png)

重新启动挖矿，查看 `eth.accounts[1]` 是否可以获得以太币

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2013.png)

查询账户余额：

> eth.getBalance(eth.accounts[0])
> eth.getBalance(eth.accounts[1])

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2014.png)

`getBalance()` 返回值的单位是wei，wei是以太币的最小单位，1个以太币=10的18次方个wei。要查看有多少个以太币，可以用web3.fromWei()将返回值换算成以太币：

> web3.fromWei(eth.getBalance(eth.accounts[0]))
> web3.fromWei(eth.getBalance(eth.accounts[1]))

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2015.png)

****4 发送交易****

从账户0转移10个以太币到账户1,首先要解锁账户 0，才能发起交易：

> personal.unlockAccount(eth.accounts[0])

输入密码解锁账户

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2016.png)

先将 10 ETH 转换为 wei 单位 并赋给变量 amount

> amount = web3.toWei(10, ‘ether’)
> eth.sendTransaction({from:eth.accounts[0],to:eth.accounts[1],value:amount})

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2017.png)

查询 账户1 的余额：

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2018.png)

发现账户余额没有发生改变，此时交易已经提交到区块链，但还未被处理，这可以通过用 `txpool.status` 命令可以看到本地交易池中有一个待确认的交易：

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2019.png)

其中有一条pending的交易，pending表示已提交但还未被处理的交易。

要使交易被处理，必须要挖矿。这里我们启动挖矿，然后等待挖到一个区块之后就停止挖矿：

> miner.start(1);admin.sleepBlocks(1);miner.stop()

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2020.png)

> web3.fromWei(eth.getBalance(eth.accounts[0]))
> web3.fromWei(eth.getBalance(eth.accounts[1]))

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2021.png)

发现账户收到了账户的钱，还多了5个以太币。其实多出的5个以太币是挖矿奖励。

****5 查看交易和区块****

查看当前区块总数：

> eth.blockNumber

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2022.png)

通过区块号查看区块：

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2023.png)

通过交易hash（hash 值包含在上面交易返回值中）查看交易：

> eth.getTransaction(”0x5e2f33b639920de139d01f8facc2fb13d34bfc9cda6c560b21abbfe5219845ed”)
> eth.getTransaction(”hash”)

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2024.png)

![Untitled](https://cdn.jsdelivr.net/gh/1055373165/image@main/Untitled%2025.png)